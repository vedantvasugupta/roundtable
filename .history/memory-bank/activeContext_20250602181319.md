# Active Context: Current Work and Focus

## Current Task

*   **Addressing User-Reported Issues (Completed):**
    *   **Campaign Voting DM Enhancements & Token Investment (`voting.py`):**
        *   Implemented `TokenInvestmentModal` for users to specify token amounts for campaign scenario votes.
        *   Updated `BaseVoteView` to integrate the token investment modal into the voting flow for campaigns.
        *   Modified `send_voting_dm` to display the user's remaining campaign tokens and the total number of scenarios in the campaign.
        *   Refactored `process_vote` and `BaseVoteView.finalize_vote` to correctly use `db.record_vote` and manage token updates via `db.update_user_remaining_tokens`.
    *   **Database Error Fix (`db.py`):**
        *   Corrected the `add_vote` function to use `proposal_id` consistently, resolving the "no such column: id" error.
    *   **Newline Formatting Fix (`utils.py`):**
        *   Adjusted string formatting in `create_proposal_embed` (specifically for "Voting Rules" and "Options" fields) to ensure `\n` is rendered as a newline in Discord embeds.
*   **Memory Bank Update:** Updating all memory bank files to reflect the current project state (this task).

## Blocked/Pending Tasks (Due to Tool Limitations)

The following desired features and improvements are currently blocked because of persistent issues with the `edit_file` tool's ability to apply complex, multi-part changes to specific functions (`CampaignSetupModal.on_submit` in `proposals.py`):

*   **Streamlined Scenario Approval:**
    *   **Goal:** Scenarios belonging to an already approved (status 'setup' or 'active') campaign should be automatically approved (e.g., status 'ApprovedScenario') without needing separate admin action.
    *   **Blocked At:** Modifying `_create_new_proposal_entry` to implement this logic.
*   **Conditional Campaign Approval Based on Constitutional Variable:**
    *   **Goal:** If the `proposal_requires_approval` constitutional variable is set to `false`, newly created campaigns should bypass the 'pending_approval' state and become 'setup' immediately, with the control panel posted directly.
    *   **Blocked At:** Modifying `CampaignSetupModal.on_submit` (and potentially `db.create_campaign` or a new helper function) to implement this conditional logic.

These items will require manual implementation or revisiting when tool capabilities improve.

## Recent Significant Changes

*   **Campaign Voting DM & Token Logic (`voting.py`):**
    *   `TokenInvestmentModal` implemented.
    *   `BaseVoteView` updated for campaign context (tokens, campaign details) and token investment flow.
    *   `send_voting_dm` now shows user's remaining tokens and total campaign scenarios.
    *   Simplified `process_vote`; `BaseVoteView.finalize_vote` now correctly calls `db.record_vote` and `db.update_user_remaining_tokens`.
*   **Database Query Fix (`db.py`):**
    *   `add_vote` function corrected to only query `proposal_id` in the `proposals` table.
*   **Embed Formatting (`utils.py`):**
    *   Corrected use of newline characters in `create_proposal_embed` for better display in Discord.
*   **Streamlined Scenario Approval & Campaign Progression (`proposals.py`, `voting_utils.py`):**
    *   **Auto-Approval of Scenarios:** In `_create_new_proposal_entry` (`proposals.py`), scenarios for campaigns in 'setup' or 'active' state are now automatically set to 'ApprovedScenario'.
    *   **Campaign Approval Cascade:** In `_perform_approve_campaign_action` (`proposals.py`), when a campaign is approved, its existing 'Pending Approval' scenarios are now transitioned to 'ApprovedScenario'.
    *   **Voting Initiation Helper:** Created `initiate_voting_for_proposal` in `voting_utils.py` to centralize logic for starting voting (DB update, announcements, DMs).
    *   **Standalone Proposal Approval:** `_perform_approve_proposal_action` (`proposals.py`) now uses `initiate_voting_for_proposal` when a standalone proposal is approved and becomes 'Voting'.
    *   **Campaign Starting Logic:** Implemented `start_next_callback` in `CampaignControlView` (`proposals.py`) to:
        *   Transition a 'setup' campaign to 'active' and start its first 'ApprovedScenario'.
        *   Start subsequent 'ApprovedScenario's in an 'active' campaign if no other scenario is 'Voting'.
    *   **Button State Refinement:** Improved `CampaignControlView.update_button_states` (`proposals.py`) to more accurately reflect prerequisites for defining/starting scenarios.
*   **Database Schema for Weighted Campaigns (Completed - Phase A Core):**
    *   Added `campaigns` table: `campaign_id`, `guild_id`, `creator_id`, `title`, `description`, `total_tokens_per_voter`, `num_expected_scenarios`, `current_defined_scenarios`, `status`, `creation_timestamp`, `control_message_id`.
    *   Added `user_campaign_participation` table.
    *   Modified `proposals` table: Added `campaign_id` (FK) and `scenario_order`.
    *   Modified `votes` table: Added `tokens_invested` and `is_abstain`.
    *   DB functions created/updated for campaign management.
*   **Campaign Creation & Scenario Definition UI (`proposals.py` - Phase A Core Completed):**
    *   `CampaignSetupModal`, `DefineScenarioView`, campaign-aware proposal modals.
*   **Campaign Control Panel (`proposals.py` - Phase A Foundation):**
    *   `CampaignControlView` created with "Define Next Scenario" and "Start Campaign/Next" buttons.
    *   Logic to post this view to a `#campaign-management` channel when a campaign is approved (`_perform_approve_campaign_action`).
    *   `update_button_states` method in `CampaignControlView` to dynamically adjust buttons (ongoing refinement needed).
    *   Initial implementation of `define_scenario_callback` in `CampaignControlView`.
    *   **Placeholder `start_next_callback` in `CampaignControlView`.**
*   **Timestamp Handling in `db.py`:**
    *   Standardized on `created_at`, `updated_at` for `proposals` table.
    *   Added `_try_drop_column` to remove old `creation_timestamp`, `last_updated_timestamp`.
    *   `_ensure_column` enhanced for `DEFAULT CURRENT_TIMESTAMP`.

## Next Steps (Immediate & Short-Term)

*   **User Testing:**
    *   Thoroughly test the updated campaign voting DM:
        *   Verify display of remaining tokens and total scenarios.
        *   Test the `TokenInvestmentModal` for input validation and correct token investment.
        *   Confirm vote submission works for campaign scenarios, including token deduction.
        *   Check DM confirmation messages.
    *   Verify the fix for the `no such column: id` error by submitting votes.
    *   Confirm that newline characters are correctly rendered in proposal channel announcements (embeds).
*   **User Testing:** (Carry-over from previous) Test the campaign approval flow, automatic scenario approval, and `CampaignControlView` functionality.
*   **User Testing:** (Carry-over from previous) Verify the behavior of `initiate_voting_for_proposal` for standalone proposals.
*   **Review and Update `progress.md` based on these changes and completed fixes.**

## Active Decisions & Considerations

*   **Tool Limitations:** The current inability of `edit_file` to handle certain complex edits is a significant constraint.
*   **User Experience for Campaign Management:** How intuitive is the campaign control panel? Are the button states and labels clear? (Ongoing consideration)
*   **Error Handling:** Robust error handling for all new campaign management and voting actions. (Ongoing consideration)

## Important Patterns & Preferences

*   **Iterative Development.**
*   **Targeted Edits (when tool permits).**
*   **Memory Bank Upkeep.**