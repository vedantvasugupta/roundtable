# Active Context: Current Work and Focus

## Current Task

*   **Verify `AdminApprovalView` Fix:** The immediate priority is for the user to test and confirm that the `AttributeError: 'AdminApprovalView' object has no attribute 'scenario_order'` is resolved. This was addressed by ensuring `scenario_order` is correctly initialized and passed within the `AdminApprovalView` class and its callbacks in `proposals.py`.
*   **Thoroughly Test Campaign Control Panel (`CampaignControlView` in `proposals.py`):**
    *   Verify that the "Define Next Scenario" and "Start Campaign / Start Next Scenario" buttons enable/disable correctly based on campaign status, number of scenarios defined/approved, and active voting scenarios.
    *   Confirm that clicking these buttons triggers the intended actions (opening scenario definition modals, starting campaigns/scenarios).
*   **Memory Bank Update:** Updating all memory bank files to reflect the current project state (this task).

## Blocked/Pending Tasks (Due to Tool Limitations)

The following desired features and improvements are currently blocked because of persistent issues with the `edit_file` tool's ability to apply complex, multi-part changes to specific functions (`_create_new_proposal_entry`, `CampaignSetupModal.on_submit` in `proposals.py`):

*   **Streamlined Scenario Approval:**
    *   **Goal:** Scenarios belonging to an already approved (status 'setup' or 'active') campaign should be automatically approved (e.g., status 'ApprovedScenario') without needing separate admin action.
    *   **Blocked At:** Modifying `_create_new_proposal_entry` to implement this logic.
*   **Conditional Campaign Approval Based on Constitutional Variable:**
    *   **Goal:** If the `proposal_requires_approval` constitutional variable is set to `false`, newly created campaigns should bypass the 'pending_approval' state and become 'setup' immediately, with the control panel posted directly.
    *   **Blocked At:** Modifying `CampaignSetupModal.on_submit` (and potentially `db.create_campaign` or a new helper function) to implement this conditional logic.

These items will require manual implementation or revisiting when tool capabilities improve.

## Recent Significant Changes

*   **`AdminApprovalView` Fix Attempt (`proposals.py`):**
    *   Ensured `__init__` correctly stores `scenario_order`.
    *   Updated `approve_button_callback` and `reject_button_callback` to use/pass `self.scenario_order`.
    *   Verified that `scenario_order` is passed during `AdminApprovalView` instantiation (line 949).
*   **Database Schema for Weighted Campaigns (Completed - Phase A Core):**
    *   Added `campaigns` table: `campaign_id`, `guild_id`, `creator_id`, `title`, `description`, `total_tokens_per_voter`, `num_expected_scenarios`, `current_defined_scenarios`, `status`, `creation_timestamp`, `control_message_id`.
    *   Added `user_campaign_participation` table.
    *   Modified `proposals` table: Added `campaign_id` (FK) and `scenario_order`.
    *   Modified `votes` table: Added `tokens_invested` and `is_abstain`.
    *   DB functions created/updated for campaign management.
*   **Campaign Creation & Scenario Definition UI (`proposals.py` - Phase A Core Completed):**
    *   `CampaignSetupModal`, `DefineScenarioView`, campaign-aware proposal modals.
*   **Campaign Control Panel (`proposals.py` - Phase A Foundation):**
    *   `CampaignControlView` created with "Define Next Scenario" and "Start Campaign/Next" buttons.
    *   Logic to post this view to a `#campaign-management` channel when a campaign is approved (`_perform_approve_campaign_action`).
    *   `update_button_states` method in `CampaignControlView` to dynamically adjust buttons (ongoing refinement needed).
    *   Initial implementation of `define_scenario_callback` in `CampaignControlView`.
    *   **Placeholder `start_next_callback` in `CampaignControlView`.**
*   **Timestamp Handling in `db.py`:**
    *   Standardized on `created_at`, `updated_at` for `proposals` table.
    *   Added `_try_drop_column` to remove old `creation_timestamp`, `last_updated_timestamp`.
    *   `_ensure_column` enhanced for `DEFAULT CURRENT_TIMESTAMP`.

## Next Steps (Immediate & Short-Term)

*   **User Testing:** Confirm `AttributeError` in `AdminApprovalView` is resolved.
*   **User Testing:** Test campaign control panel functionality (`CampaignControlView`).
*   **Implement `start_next_callback` in `CampaignControlView` (`proposals.py`):** This is the core logic for the "Start Campaign / Start Next Scenario" button.
    *   Handle starting a campaign (status `setup` -> `active`, start first scenario's voting).
    *   Handle starting the next approved scenario if the campaign is active and the previous scenario is closed.
*   **Refine `CampaignControlView.update_button_states` (`proposals.py`):** Ensure comprehensive and accurate button state changes based on campaign and scenario statuses.
*   **Complete `TokenInvestmentModal` & `BaseVoteView.finalize_vote` (`voting.py`) (Carry-over from previous context).**

## Active Decisions & Considerations

*   **Tool Limitations:** The current inability of `edit_file` to handle certain complex edits is a significant constraint.
*   **User Experience for Campaign Management:** How intuitive is the campaign control panel? Are the button states and labels clear?
*   **Error Handling:** Robust error handling for all new campaign management actions.

## Important Patterns & Preferences

*   **Iterative Development.**
*   **Targeted Edits (when tool permits).**
*   **Memory Bank Upkeep.**