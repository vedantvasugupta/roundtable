# Progress: Current State and Future Work

## What Works

*   **Core Bot Functionality:** Bot runs, connects, basic command handling.
*   **Modular Structure:** Code organized into modules.
*   **Database Initialization:** `db.py` initializes tables.
*   **Two-Step Proposal Creation (Refined):**
    *   `!propose` triggers `ProposalMechanismSelectionView` -> mechanism-specific modal.
    *   **Modal Component Limits Respected:** `BaseProposalModal` now has 3 core `TextInput`s (Title, Options, Deadline). Subclass modals add up to 2 specific `TextInput`s for hyperparameters (e.g., `allow_abstain`, `winning_threshold_percentage`, `num_seats`), ensuring the total is 5 or less. This fixed previous `ValueError` issues.
    *   **Description Field Removed from UI:** The proposal description is no longer an input in the modals; a default value ("No description provided.") is used.
    *   Relevant hyperparameters are captured and stored.
*   **Admin Notification for Approval:** New proposals requiring approval trigger an admin notification with buttons.
*   **Proposal Approval & DM Dispatch (Plurality & Approval):**
    *   Approving a proposal correctly changes its status to "Voting".
    *   The system now attempts to send DMs to eligible voters using `voting.send_voting_dm`.
    *   `db.add_voting_invite` is called to record who was invited.
*   **DM Voting UI (Plurality & Approval - improved):**
    *   `PluralityVoteView` and `ApprovalVoteView` in `voting.py` are used for DM voting.
    *   Users can select options and (if allowed) abstain.
    *   The `submit_callback` in `BaseVoteView` calls `process_vote`.
    *   Corrected `AttributeError` in `ApprovalVoteView` submit logic.
*   **Vote Recording (Plurality & Approval):**
    *   The `process_vote` function in `voting.py` calls `db.record_vote` to store votes.
*   **Result Calculation (Plurality & Approval - improved):**
    *   `ApprovalVoting.count_votes` in `voting_utils.py` now correctly accepts necessary arguments, initializes results with all official options, and tallies valid options.
    *   `PluralityVoting.count_votes` also initializes results based on all official options.
*   **Vote Tracking Message:** `voting_utils.update_vote_tracking` updates a message in `voting-room` with progress.
*   **Timestamp Handling:** Corrected for new proposals.

## What's Left to Build / Verify Thoroughly

*   **Thorough Testing of All Proposal Modals:** Ensure the new structure (Base 3 items + Subclass up to 2 items) works for all mechanism types and that all intended hyperparameters are correctly captured.
*   **Full Voting Lifecycle Testing (All Mechanisms - carry over):**
    *   **Plurality & Approval:** Confirm end-to-end flow.
    *   **Borda Count & Runoff:** Implement/Verify `RankedVoteView`, ensure `count_votes` processes ranked choices and hyperparameters.
    *   **D'Hondt Method:** Confirm DM voting, ensure `count_votes` is robust and results are clear.
*   **Hyperparameter Implementation & Testing (All Mechanisms - carry over):**
    *   Verify storage and use of hyperparameters by `voting_utils.py` counting functions.
*   **Early Proposal Closure Logic (carry over).**
*   **Admin Approval Workflow (carry over).**
*   **Edge Cases & Error Handling (carry over).**

## Known Issues & Considerations

*   **`RankedVoteView` Implementation (carry over).**
*   **D'Hondt Method Interpretation for Single Winner (carry over).**
*   **Timestamp Format for Existing Data (carry over).**
*   **Modal Component Limits:** Actively managed by the new 3+2 item structure.
*   **`original_interaction` Handling in Views (carry over).**

## Evolution of Project Decisions

*   **Modal Design for Proposal Creation:** The structure of proposal modals has been significantly refactored. `BaseProposalModal` now provides 3 core fields (Title, Options, Deadline). Subclass modals add up to 2 mechanism-specific hyperparameter fields (e.g., `allow_abstain_input`, `winning_threshold_percentage_input`, `num_seats_input`) to stay within Discord's 5 `TextInput` component limit. The "Description" field was removed from the UI to accommodate this and is now defaulted.