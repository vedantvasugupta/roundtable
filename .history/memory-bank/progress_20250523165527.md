# Progress: Current State and Future Work

## What Works

*   **Core Bot Functionality:** The bot runs, connects to Discord, and basic command handling is in place.
*   **Modular Structure:** Code is organized into modules (`main.py`, `db.py`, `proposals.py`, `voting.py`, `voting_utils.py`, `utils.py`).
*   **Database Initialization:** `db.py` initializes the SQLite database with necessary tables.
*   **Two-Step Proposal Creation (Initial Implementation):**
    *   The `!propose` command triggers `ProposalMechanismSelectionView` with buttons for voting mechanisms.
    *   Clicking a mechanism button displays a (mostly) functional mechanism-specific modal (e.g., `PluralityProposalModal`, `BordaProposalModal`).
    *   Basic proposal data (title, description, options, deadline, selected mechanism) can be submitted.
    *   Hyperparameters (like `allow_abstain`, `num_seats` for D'Hondt) are captured for some modals.
    *   Proposals are stored in the `proposals` table, and options in `proposal_options`.
    *   The `hyperparameters` field in the `proposals` table stores JSON for mechanism-specific settings.
*   **Timestamp Handling (for new proposals):** Deadline timestamps for newly created proposals are now stored in a space-separated format (`YYYY-MM-DD HH:MM:SS.ffffff`) to avoid SQLite conversion errors on read.
*   **Admin Notification (Initial):** Logic to call `notify_admins_of_pending_proposals` is in place when a new proposal requires approval.
*   **Basic UI Customizations:** Proposal title minimum length reduced, description field made optional.
*   **Cleanup Script:** A script (`cleanup_pending_proposals.py`) was created to address an issue with old proposals stuck in a pending announcement state.

## What's Left to Build / Verify Thoroughly

*   **Complete Hyperparameter Implementation & Testing:**
    *   Ensure all defined modals (`Plurality`, `Borda`, `Approval`, `Runoff`, `DHondt`) correctly capture their intended hyperparameters.
    *   Verify these hyperparameters are correctly stored in the JSON field in the database.
    *   Confirm that `voting_utils.py` (and specific mechanism counting functions like `PluralityVoting.count_votes`) correctly retrieve and utilize these hyperparameters during vote counting and result determination.
    *   Re-evaluate and implement `winning_threshold` for Plurality if deemed critical.
*   **Full Voting Lifecycle Testing:** For each voting mechanism:
    *   Proposal creation (as above).
    *   Vote casting (DM interactions, vote storage).
    *   Deadline expiration and automated closing (`check_expired_proposals` in `voting_utils.py`).
    *   Correct vote tabulation based on the mechanism and any stored hyperparameters.
    *   Result announcement (`close_and_announce_results` in `voting_utils.py`).
*   **Admin Approval Workflow:**
    *   Thoroughly test the `!approve_proposal` and `!reject_proposal` commands.
    *   Ensure proposals correctly transition status (Pending -> Voting/Rejected).
    *   Confirm admin notifications for pending proposals work reliably and provide clear information.
*   **Constitutional Variable Integration:**
    *   Ensure `proposal_requires_approval` constitutional variable is correctly read and applied during proposal creation.
    *   Test other constitutional variables related to proposals and voting if they impact these flows.
*   **Slash Command Equivalence:** While `!propose` (message command) is the primary focus of recent refactoring, consider future compatibility or migration to a slash command `/propose` for better UX with initial interaction objects.
*   **Error Handling and User Feedback:** Robustly test error conditions and ensure user-friendly error messages are provided for all interactions.
*   **Edge Case Testing:** Consider edge cases like proposals with no options, invalid duration inputs, etc.

## Known Issues & Considerations

*   **Timestamp Format for Existing Data:** Old proposals in the database might still have `deadline` timestamps with a 'T' separator, potentially causing `ValueError` during reads by `notify_admins_of_pending_proposals` or other functions. This may require a one-time data migration script or the implementation of custom SQLite datetime converters if it becomes problematic.
*   **Modal Component Limits (5 TextInputs):** This remains a constraint for complex hyperparameter configurations within a single modal.
*   **`original_interaction` Handling:** The `ProposalMechanismSelectionView` correctly handles cases where `original_interaction` is `None` (for message commands), but this means it cannot edit the initial message on timeout/completion in those scenarios.

## Evolution of Project Decisions

*   **Proposal Creation UX:** Shifted from a single complex modal to a two-step (View with buttons -> specific Modal) approach to handle dynamic field requirements based on voting mechanism selection. This was a key architectural change to overcome Discord API limitations.
*   **Hyperparameter Storage:** Moved from potentially many distinct DB columns to a single JSON `hyperparameters` column in the `proposals` table for flexibility.
*   **Timestamp Storage:** Adjusted to store datetime strings with space separators instead of 'T' to align with SQLite's default converters, after encountering `ValueError`s.