# Progress: Current State and Future Work

## What Works

*   **Core Bot Functionality:** Bot runs, connects, basic command handling.
*   **Modular Structure:** Code organized into modules.
*   **Database Initialization & Schema (Weighted Campaigns - Phase A Core):
    *   `db.py` initializes tables, including new `campaigns` and `user_campaign_participation` tables.
    *   `proposals` table updated with `campaign_id`, `scenario_order`.
    *   `votes` table updated with `tokens_invested`, `is_abstain`.
    *   Relevant CRUD functions in `db.py` for campaigns and participation created/updated.
    *   **DB Fixes:** Resolved `sqlite3.OperationalError: Cannot add a NOT NULL column with default value NULL` for all relevant timestamp columns by adding `DEFAULT CURRENT_TIMESTAMP` in `_ensure_column` calls. Fixed other minor DB init errors.
*   **Campaign Creation & Scenario Definition UI (`proposals.py` - Phase A Core):
    *   `!propose` flow allows initiating a standalone proposal or a new Weighted Campaign via `ProposalMechanismSelectionView`.
    *   `CampaignSetupModal` allows defining campaign title, description, total tokens per voter, and number of scenarios.
    *   `DefineScenarioView` guides the user through defining each scenario for the campaign sequentially.
    *   Mechanism selection (`ProposalMechanismSelectionView`) and proposal modals (`BaseProposalModal` subclasses) are correctly used for each scenario, passing campaign context.
    *   `_create_new_proposal_entry` handles DB updates for scenarios (`db.increment_defined_scenarios`) and manages the flow to the next scenario definition or campaign completion message.
    *   Admin notifications for scenario approval are campaign-aware.
*   **Embeds for Campaign Context (`utils.py` - Phase A Core):**
    *   `create_proposal_embed` updated to display campaign information.
*   **DM Voting Setup (`voting.py` - Phase A Foundation):
    *   `send_voting_dm` updated to retrieve campaign details (`get_campaign`) and user's total campaign tokens (`get_user_remaining_tokens`).
    *   Enrolls user in campaign (`enroll_voter_in_campaign`) if not already participating when a DM for a campaign scenario is sent.
    *   Passes campaign context to `BaseVoteView` subclasses.
    *   `BaseVoteView` `__init__` updated to accept and store campaign parameters.
    *   `AbstainButton` callback sets `view.is_abstain_vote = True`.
    *   Mechanism-specific view callbacks (e.g., `PluralityVoteView.option_callback`) store selections in `view.selected_mechanism_vote_data`.
    *   All mechanism view callbacks now correctly trigger `BaseVoteView.submit_vote_callback`.
*   **Partial Vote Processing & Recording (`voting.py` - Phase A Foundation):
    *   `BaseVoteView.submit_vote_callback` (renamed from `submit_callback`) defers and then (for campaign) should present `TokenInvestmentModal` (currently a placeholder).
    *   A simplified `process_vote` stub exists that logs vote data.
    *   `db.record_vote` in `db.py` is updated to accept and store `tokens_invested` and `is_abstain`.
*   **Vote Tallying Logic - Initial Token Weighting (`voting_utils.py` - Phase A Foundation):
    *   `PluralityVoting.count_votes`, `BordaCount.count_votes`, `ApprovalVoting.count_votes`, `RunoffVoting.count_votes`, `DHondtMethod.count_votes` updated to accept `tokens_invested` via vote records and apply it as a weight to votes/scores.
    *   `calculate_results` function passes the votes (which include `tokens_invested`) to the specific counting methods.
    *   `format_vote_results` has been significantly updated to display detailed weighted results.

## What's Left to Build / Verify Thoroughly

*   **Weighted Campaign Feature - Phase A Completion:**
    *   **`TokenInvestmentModal` (`voting.py`):** Fully implement the modal for users to input their token investment for a scenario. Include validation (numeric, within remaining balance).
    *   **`BaseVoteView.finalize_vote` (`voting.py`):** Implement the logic to:
        *   Take `tokens_invested_this_scenario` (from `TokenInvestmentModal`).
        *   Call global `process_vote` with full vote data (including tokens).
        *   On successful vote processing, call `db.update_user_remaining_tokens`.
        *   Update the DM message (disable view, confirm vote and token usage).
    *   **`process_vote` (`voting.py`):** Ensure it correctly calls `db.record_vote` with all necessary fields from `vote_data` (abstain status, mechanism-specific data, tokens invested).
    *   **End-to-End Testing (All Mechanisms in Campaigns):**
        *   Create campaigns, define scenarios with each voting type.
        *   Vote via DM, invest tokens, verify token deduction.
        *   Verify weighted vote counting in `voting_utils.py` for each mechanism.
        *   Verify `format_vote_results` presents accurate weighted results and campaign context.
*   **Campaign Management Features (Phase B - Future):**
    *   Admin commands to activate a campaign (status `setup` -> `active`), triggering voting for the first scenario.
    *   Automated progression to the next scenario upon completion of the current one.
    *   Display of user's overall token usage/status within a campaign.
    *   Commands for campaign overview, manual status changes (pause, complete, archive).
*   **Robust Error Handling:** Especially around token investment and campaign state transitions.
*   **Full Voting Lifecycle Testing (Standalone Proposals - carry over).**
*   **Hyperparameter Implementation & Testing (Standalone Proposals - carry over).**

## Known Issues & Considerations

*   **`RankedVoteView` Implementation (Standalone/Campaign):** Still needs careful implementation/verification for Borda and Runoff if not fully covered by recent `BaseVoteView` updates.
*   **Clarity of D'Hondt Results (Standalone/Campaign - carry over).**
*   **Timestamp Format for Existing Data (carry over - though `fix_malformed_timestamps` and `DEFAULT CURRENT_TIMESTAMP` for new columns helps new data).**
*   **`original_interaction` Handling in Views (carry over):** Ensure consistent and correct usage for editing messages, especially in complex multi-step UI flows like campaign setup.

## Evolution of Project Decisions

*   **Modal Design for Proposal Creation:** Structure refined to 3 base + 2 specific inputs to meet Discord limits. Description field defaulted.
*   **Weighted Campaigns Introduced:** A major new feature involving new DB tables, UI flows for setup, and modifications to voting and results processing to incorporate token investment as vote weight.
*   **Database Schema Evolution:** Iteratively adding tables and columns (e.g., for campaigns, tokens) using `_ensure_column` with `DEFAULT CURRENT_TIMESTAMP` for new `NOT NULL` timestamp columns to ensure smoother migrations.