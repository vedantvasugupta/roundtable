# Progress: Current State and Future Work

## What Works

*   **Core Bot Functionality:** Bot runs, connects, basic command handling.
*   **Modular Structure:** Code organized into modules.
*   **Database Fixes & Enhancements (`db.py`):
    *   `add_vote` function corrected to prevent "no such column: id" error.
    *   `record_vote` function correctly handles INSERT/UPDATE logic for votes, including `tokens_invested` and `is_abstain`.
    *   `update_user_remaining_tokens` function available for campaign token management.
    *   Database Initialization & Schema (Weighted Campaigns - Phase A Core):
        *   `db.py` initializes tables, including new `campaigns` and `user_campaign_participation` tables.
        *   `proposals` table updated with `campaign_id`, `scenario_order`.
        *   `votes` table updated with `tokens_invested`, `is_abstain`.
*   **Campaign Voting DM Enhancements & Token Investment (`voting.py`):
    *   `TokenInvestmentModal` implemented for users to specify token amounts for campaign scenario votes.
    *   `BaseVoteView` updated to integrate the token investment modal, handle campaign context (remaining tokens, total scenarios), and manage the vote finalization process.
    *   `send_voting_dm` now correctly displays the user's remaining campaign tokens and total campaign scenarios in the DM embed.
    *   Voting logic now calls `db.record_vote` and `db.update_user_remaining_tokens` as appropriate.
*   **Embed Formatting (`utils.py`):
    *   `create_proposal_embed` corrected to ensure `\n` renders as actual newlines in Discord embeds, fixing issues with proposal channel announcements.
*   **Campaign Creation & Scenario Definition UI (`proposals.py` - Phase A Core):
    *   `!propose` flow allows initiating a standalone proposal or a new Weighted Campaign.
    *   `CampaignSetupModal`, `DefineScenarioView`, and mechanism-specific modals handle campaign and scenario creation.
*   **Campaign Approval and Scenario Progression (Phase 1 Complete):
    *   Campaigns can be created, approved by admins (transitioning to 'setup').
    *   Scenarios for approved campaigns are auto-set to 'ApprovedScenario'.
    *   `CampaignControlView` allows defining and starting scenarios.
    *   `voting_utils.initiate_voting_for_proposal` handles starting votes for standalone proposals and campaign scenarios.
*   **Vote Tallying Logic - Initial Token Weighting (`voting_utils.py` - Phase A Foundation):
    *   Vote counting methods updated for `tokens_invested`.
    *   `format_vote_results` displays weighted results.

## What's Left to Build / Verify Thoroughly

*   **Thorough User Testing of Recent Fixes:**
    *   **Campaign Voting Flow:**
        *   Verify DM content (remaining tokens, total scenarios).
        *   Test `TokenInvestmentModal` (input validation, token investment, confirmation messages).
        *   Confirm vote submission (including for abstain votes with 0 tokens) and token deduction works correctly for all mechanisms within campaigns.
    *   **Database Error:** Confirm the "no such column: id" error is gone when submitting votes.
    *   **Embed Formatting:** Confirm newlines in proposal announcements (especially options and voting rules sections) render correctly.
*   **Thorough Testing of Campaign Lifecycle & Scenario Progression (Carry-over):
    *   End-to-end testing of campaign creation, approval, scenario definition (including auto-approval logic), starting the campaign, progressing through scenarios, and vote tallying.
    *   Verify all button states in `CampaignControlView` under various conditions.
    *   Confirm `initiate_voting_for_proposal` works as expected in all contexts.
*   **Weighted Campaign Feature - Further Refinements & Testing:
    *   Review and test `process_vote` in `voting.py` for any remaining validation logic that should be in the View/Modal layer or `finalize_vote`.
    *   End-to-End Testing (All Mechanisms in Campaigns): Ensure all voting mechanisms function correctly with token weighting from DM to results.
*   **Campaign Management Features (Phase B - Future - Refined Scope):
    *   Display of user's overall token usage/status within a campaign.
    *   Admin commands for campaign overview and manual status changes.
    *   Automated campaign completion when all scenarios are 'Closed'.
*   **Robust Error Handling:** Especially around token investment, campaign state transitions, and interactions with the `CampaignControlView`.

## Known Issues & Considerations

*   **`TokenInvestmentModal` and `BaseVoteView.finalize_vote` (`voting.py`):** Implemented but require thorough testing to ensure robustness and correct behavior in all scenarios (e.g., edge cases for token values, interaction deferrals).
*   **Validation in `process_vote` (`voting.py`):** Some validation logic might still reside in `process_vote`. Ideally, all user input validation should occur in the UI layer (Views/Modals) before calling `finalize_vote` or `process_vote`.
*   **`RankedVoteView` Implementation (Standalone/Campaign):** Still needs careful implementation/verification.
*   **Clarity of D'Hondt Results (Standalone/Campaign - carry over).**

## Evolution of Project Decisions

*   **Modal Design for Proposal Creation:** Structure refined to 3 base + 2 specific inputs to meet Discord limits.
*   **Weighted Campaigns Introduced:** A major new feature involving new DB tables, UI flows for setup, and modifications to voting and results processing to incorporate token investment as vote weight.
*   **Refinement of Voting Flow (`voting.py`):** `BaseVoteView` and related components were significantly updated to handle the token investment modal and correctly process campaign votes, including direct calls to `db.record_vote` and `db.update_user_remaining_tokens`.
*   **Database Error Resolution (`db.py`):** Queries updated to align with schema changes (e.g., exclusive use of `proposal_id`).
*   **Embed Formatting (`utils.py`):** Corrected newline handling for improved display.