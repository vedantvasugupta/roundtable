# Active Context: Current Work and Focus

## Current Task

*   **Thoroughly Test Campaign and Scenario Approval/Start Flows:**
    *   Verify that scenarios defined for an already approved campaign (status 'setup' or 'active') are automatically set to 'ApprovedScenario'.
    *   Test the `_perform_approve_campaign_action` in `proposals.py` to ensure it correctly auto-approves existing 'Pending Approval' scenarios for that campaign.
    *   Test the `CampaignControlView` (`proposals.py`):
        *   Confirm "Define Next Scenario" and "Start Campaign / Start Next Scenario" buttons enable/disable correctly.
        *   Verify that clicking "Start Campaign / Start Next Scenario" correctly:
            *   Changes campaign status from 'setup' to 'active' and starts Scenario 1 if it's 'ApprovedScenario'.
            *   Starts the next 'ApprovedScenario' if the campaign is 'active', no other scenario is 'Voting', and the previous scenario is 'Closed'.
            *   Provides correct feedback if conditions for starting are not met.
*   **Test `initiate_voting_for_proposal` (`voting_utils.py`):**
    *   Ensure it correctly sets proposal status to 'Voting'.
    *   Verify vote announcements in 'proposals' and 'voting-room' channels.
    *   Confirm DMs are sent to eligible voters.
*   **Memory Bank Update:** Updating all memory bank files to reflect the current project state (this task).

## Blocked/Pending Tasks (Due to Tool Limitations)

The following desired features and improvements are currently blocked because of persistent issues with the `edit_file` tool's ability to apply complex, multi-part changes to specific functions (`CampaignSetupModal.on_submit` in `proposals.py`):

*   **Streamlined Scenario Approval:**
    *   **Goal:** Scenarios belonging to an already approved (status 'setup' or 'active') campaign should be automatically approved (e.g., status 'ApprovedScenario') without needing separate admin action.
    *   **Blocked At:** Modifying `_create_new_proposal_entry` to implement this logic.
*   **Conditional Campaign Approval Based on Constitutional Variable:**
    *   **Goal:** If the `proposal_requires_approval` constitutional variable is set to `false`, newly created campaigns should bypass the 'pending_approval' state and become 'setup' immediately, with the control panel posted directly.
    *   **Blocked At:** Modifying `CampaignSetupModal.on_submit` (and potentially `db.create_campaign` or a new helper function) to implement this conditional logic.

These items will require manual implementation or revisiting when tool capabilities improve.

## Recent Significant Changes

*   **Streamlined Scenario Approval & Campaign Progression (`proposals.py`, `voting_utils.py`):**
    *   **Auto-Approval of Scenarios:** In `_create_new_proposal_entry` (`proposals.py`), scenarios for campaigns in 'setup' or 'active' state are now automatically set to 'ApprovedScenario'.
    *   **Campaign Approval Cascade:** In `_perform_approve_campaign_action` (`proposals.py`), when a campaign is approved, its existing 'Pending Approval' scenarios are now transitioned to 'ApprovedScenario'.
    *   **Voting Initiation Helper:** Created `initiate_voting_for_proposal` in `voting_utils.py` to centralize logic for starting voting (DB update, announcements, DMs).
    *   **Standalone Proposal Approval:** `_perform_approve_proposal_action` (`proposals.py`) now uses `initiate_voting_for_proposal` when a standalone proposal is approved and becomes 'Voting'.
    *   **Campaign Starting Logic:** Implemented `start_next_callback` in `CampaignControlView` (`proposals.py`) to:
        *   Transition a 'setup' campaign to 'active' and start its first 'ApprovedScenario'.
        *   Start subsequent 'ApprovedScenario's in an 'active' campaign if no other scenario is 'Voting'.
    *   **Button State Refinement:** Improved `CampaignControlView.update_button_states` (`proposals.py`) to more accurately reflect prerequisites for defining/starting scenarios.
*   **`AdminApprovalView` Fix Attempt (`proposals.py`):**
    *   Ensured `__init__` correctly stores `proposal_id` (implicitly, by using it in `custom_id`).
    *   Callbacks now fetch `proposal_id` from `interaction.data['custom_id']` and then proposal details (including `campaign_id`, `scenario_order`) from the database.
*   **Database Schema for Weighted Campaigns (Completed - Phase A Core):**
    *   Added `campaigns` table: `campaign_id`, `guild_id`, `creator_id`, `title`, `description`, `total_tokens_per_voter`, `num_expected_scenarios`, `current_defined_scenarios`, `status`, `creation_timestamp`, `control_message_id`.
    *   Added `user_campaign_participation` table.
    *   Modified `proposals` table: Added `campaign_id` (FK) and `scenario_order`.
    *   Modified `votes` table: Added `tokens_invested` and `is_abstain`.
    *   DB functions created/updated for campaign management.
*   **Campaign Creation & Scenario Definition UI (`proposals.py` - Phase A Core Completed):**
    *   `CampaignSetupModal`, `DefineScenarioView`, campaign-aware proposal modals.
*   **Campaign Control Panel (`proposals.py` - Phase A Foundation):**
    *   `CampaignControlView` created with "Define Next Scenario" and "Start Campaign/Next" buttons.
    *   Logic to post this view to a `#campaign-management` channel when a campaign is approved (`_perform_approve_campaign_action`).
    *   `update_button_states` method in `CampaignControlView` to dynamically adjust buttons (ongoing refinement needed).
    *   Initial implementation of `define_scenario_callback` in `CampaignControlView`.
    *   **Placeholder `start_next_callback` in `CampaignControlView`.**
*   **Timestamp Handling in `db.py`:**
    *   Standardized on `created_at`, `updated_at` for `proposals` table.
    *   Added `_try_drop_column` to remove old `creation_timestamp`, `last_updated_timestamp`.
    *   `_ensure_column` enhanced for `DEFAULT CURRENT_TIMESTAMP`.

## Next Steps (Immediate & Short-Term)

*   **User Testing:** Test the new campaign approval flow, automatic scenario approval, and the `CampaignControlView` functionality (defining and starting scenarios).
*   **User Testing:** Verify the behavior of `initiate_voting_for_proposal` for standalone proposals.
*   **Refine `CampaignControlView.update_button_states` (`proposals.py`):** Further ensure comprehensive and accurate button state changes based on campaign and scenario statuses after testing.
*   **Complete `TokenInvestmentModal` & `BaseVoteView.finalize_vote` (`voting.py`) (Carry-over from previous context).**
*   **Review and Update `progress.md` and other Memory Bank files based on these extensive changes.**

## Active Decisions & Considerations

*   **Tool Limitations:** The current inability of `edit_file` to handle certain complex edits is a significant constraint.
*   **User Experience for Campaign Management:** How intuitive is the campaign control panel? Are the button states and labels clear?
*   **Error Handling:** Robust error handling for all new campaign management actions.

## Important Patterns & Preferences

*   **Iterative Development.**
*   **Targeted Edits (when tool permits).**
*   **Memory Bank Upkeep.**