# Active Context: Current Work and Focus

## Current Task

*   **Implementing Weighted Campaign Feature (Phase A - Voting & Results):** The primary focus is on completing the core infrastructure for weighted campaigns. This involves:
    *   Finalizing DM voting logic in `voting.py` (`BaseVoteView` subclasses and `TokenInvestmentModal`) to correctly handle token input from users for campaign scenarios.
    *   Ensuring `process_vote` in `voting.py` correctly updates `user_campaign_participation.remaining_tokens` via `db.update_user_remaining_tokens`.
    *   Verifying that all vote counting mechanisms in `voting_utils.py` (`PluralityVoting`, `BordaCount`, `ApprovalVoting`, `RunoffVoting`, `DHondtMethod`) correctly use `tokens_invested` to weigh votes.
    *   Updating `format_vote_results` in `voting_utils.py` to clearly display token-weighted results and campaign context.
*   **Thorough Testing:** End-to-end testing of the campaign creation, scenario definition, DM voting with token investment, vote recording, weighted result calculation, and result display.
*   **Memory Bank Update:** Updating all memory bank files to reflect the current project state (this task).

## Recent Significant Changes

*   **Database Schema for Weighted Campaigns (Completed - Phase A Core):**
    *   Added `campaigns` table: `campaign_id`, `guild_id`, `creator_id`, `title`, `description`, `total_tokens_per_voter`, `num_expected_scenarios`, `current_defined_scenarios`, `status`, `creation_timestamp`.
    *   Added `user_campaign_participation` table: `participation_id`, `campaign_id`, `user_id`, `remaining_tokens`, `last_updated_timestamp`.
    *   Modified `proposals` table: Added `campaign_id` (FK) and `scenario_order`.
    *   Modified `votes` table: Added `tokens_invested` and `is_abstain`.
    *   DB functions created/updated: `create_campaign`, `get_campaign`, `update_campaign_status`, `increment_defined_scenarios`, `enroll_voter_in_campaign`, `get_user_remaining_tokens`, `update_user_remaining_tokens`, and updates to `create_proposal` & `record_vote`.
*   **Database Initialization Fixes (Completed):**
    *   Resolved `sqlite3.OperationalError: Cannot add a NOT NULL column with default value NULL` by ensuring all `_ensure_column` calls in `db.py` for `TEXT NOT NULL` timestamp columns include `DEFAULT CURRENT_TIMESTAMP`.
    *   Fixed `NameError` for `CREATE_PENDING_PROPOSAL_NOTIFICATIONS_TABLE` by adding its definition to `db.py`.
    *   Corrected SQL syntax error in `CREATE_USER_CAMPAIGN_PARTICIPATION_TABLE` (removed internal comment).
*   **Campaign Creation & Scenario Definition UI (`proposals.py` - Phase A Core Completed):**
    *   `CampaignSetupModal` for campaign-level settings.
    *   `DefineScenarioView` for guiding multi-scenario definition.
    *   Modified `ProposalMechanismSelectionView`, `BaseProposalModal` (and subclasses), `_create_new_proposal_entry`, `AdminApprovalView`, `_perform_approve_proposal_action` to be campaign-aware.
*   **Embed Updates (`utils.py` - Phase A Core Completed):**
    *   `create_proposal_embed` updated for campaign context.
*   **DM Voting Setup (`voting.py` - Phase A In Progress):**
    *   `send_voting_dm` updated to fetch campaign info, enroll user (if first DM for campaign), and pass context to vote views.
    *   `AbstainButton` and `BaseVoteView` `__init__` updated for campaign parameters.
    *   Introduced `TokenInvestmentModal` (placeholder) for users to input token amounts for scenarios.
    *   Mechanism-specific view callbacks (`option_callback`, `rank_callback`) in `PluralityVoteView`, `RankedVoteView`, `ApprovalVoteView` updated to store selections in `self.selected_mechanism_vote_data` and trigger `BaseVoteView.submit_vote_callback`.
*   **Vote Processing (`voting.py` - Phase A In Progress):**
    *   `process_vote` updated to handle new `vote_data` structure (`did_abstain`, `mechanism_data`, `tokens_invested`) and call `db.record_vote`.
*   **Vote Counting Logic (`voting_utils.py` - Phase A In Progress/Partially Complete):**
    *   `PluralityVoting.count_votes`, `BordaCount.count_votes`, `ApprovalVoting.count_votes` (user-updated), `RunoffVoting.count_votes`, `DHondtMethod.count_votes` modified to accept `tokens_invested` from vote records and use it as a weight.
    *   Main `calculate_results` function updated to pass `tokens_invested` to specific counting methods.
*   **Result Formatting (`voting_utils.py` - Phase A In Progress):**
    *   `format_vote_results` significantly updated to handle and display detailed token-weighted results for all mechanisms.

## Next Steps (Immediate & Short-Term)

*   **Complete `TokenInvestmentModal`:** Implement the UI and logic for `TokenInvestmentModal` in `voting.py` for users to specify token investment for a scenario.
*   **Finalize `BaseVoteView.finalize_vote`:** Ensure it correctly calls `db.update_user_remaining_tokens` after a successful vote in a campaign scenario.
*   **Rigorous Testing (Weighted Campaigns - Phase A):**
    *   Full end-to-end test of campaign creation, defining multiple scenarios with different mechanisms.
    *   DM voting for each scenario type: ensure token investment prompt, correct token deduction, and weighted vote recording.
    *   Verify vote counting in `voting_utils.py` correctly applies token weights for all mechanisms.
    *   Verify `format_vote_results` accurately displays weighted results, campaign progress, and user token usage.
*   **Campaign Activation/Management (Phase B - Future):**
    *   Admin commands to activate a fully defined campaign (changes status from 'setup' to 'active', starts voting for the first scenario).
    *   Logic for automatically starting the next scenario's voting when the previous one closes.
    *   Commands for campaign overview, pausing, or archiving.

## Active Decisions & Considerations

*   **Error Handling for Token Investment:** How to handle cases where a user tries to invest more tokens than they have remaining, or invalid input in `TokenInvestmentModal`.
*   **Display of Token Usage:** How and where to show users their overall token usage within a campaign (e.g., in DM footers, a separate `!campaign_status` command).
*   **Clarity of Campaign Results:** Ensuring the final campaign results (if any overarching result is calculated beyond individual scenarios) are presented clearly.

## Important Patterns & Preferences

*   **Iterative Development:** Building features in phases (e.g., Phase A: Core infrastructure for weighted campaigns).
*   **Targeted Edits:** Preferring smaller, focused code changes, especially for complex files like `db.py` and `proposals.py`.
*   **Memory Bank Upkeep.**