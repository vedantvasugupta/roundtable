# Progress: Current State and Future Work

## What Works

*   **Core Bot Functionality:** Bot runs, connects, basic command handling.
*   **Modular Structure:** Code organized into modules.
*   **Database Initialization:** `db.py` initializes tables.
*   **Two-Step Proposal Creation:** `!propose` triggers `ProposalMechanismSelectionView` -> mechanism-specific modal. Basic data & some hyperparameters captured and stored.
*   **Admin Notification for Approval:** New proposals requiring approval trigger an admin notification with buttons.
*   **Proposal Approval & DM Dispatch (Plurality & Approval):**
    *   Approving a proposal correctly changes its status to "Voting".
    *   The system now attempts to send DMs to eligible voters using `voting.send_voting_dm`.
    *   `db.add_voting_invite` is called to record who was invited.
*   **DM Voting UI (Plurality & Approval - improved):**
    *   `PluralityVoteView` and `ApprovalVoteView` in `voting.py` are used for DM voting.
    *   Users can select options and (if allowed) abstain.
    *   The `submit_callback` in `BaseVoteView` calls `process_vote`.
    *   Corrected `AttributeError` in `ApprovalVoteView` submit logic.
*   **Vote Recording (Plurality & Approval):**
    *   The `process_vote` function in `voting.py` (now correctly defined) calls `db.record_vote` to store votes.
*   **Result Calculation (Plurality & Approval - improved):**
    *   `ApprovalVoting.count_votes` in `voting_utils.py` now correctly accepts necessary arguments, initializes results with all official options, and tallies valid options.
    *   `PluralityVoting.count_votes` also initializes results based on all official options.
*   **Vote Tracking Message:** `voting_utils.update_vote_tracking` updates a message in `voting-room` with progress.
*   **Timestamp Handling:** Corrected for new proposals.

## What's Left to Build / Verify Thoroughly

*   **Full Voting Lifecycle Testing (All Mechanisms):**
    *   **Plurality & Approval:** Confirm end-to-end flow including result announcement and accuracy after recent fixes.
    *   **Borda Count & Runoff:**
        *   Implement/Verify `RankedVoteView` for DM interactions in `voting.py`.
        *   Ensure `BordaCount.count_votes` and `RunoffVoting.count_votes` in `voting_utils.py` correctly process ranked choices and any hyperparameters. Test with various ranking scenarios.
    *   **D'Hondt Method:**
        *   Confirm DM voting works (likely using `PluralityVoteView`).
        *   Ensure `DHondtMethod.count_votes` is robust and that results (especially quotients and winner determination for single-winner proposals) are clearly presented.
*   **Hyperparameter Implementation & Testing (All Mechanisms):**
    *   Ensure all modals correctly capture their intended hyperparameters.
    *   Verify storage in the database's JSON field.
    *   Confirm that `voting_utils.py` counting functions correctly retrieve and *use* these hyperparameters (e.g., `winning_threshold` for Plurality, `num_seats` for D'Hondt if applicable to single-winner context).
*   **Early Proposal Closure Logic:** Design and implement a robust way to handle early closure if 100% of invited/eligible users vote.
*   **Admin Approval Workflow:** Continue to test `!approve_proposal` and `!reject_proposal`, especially the flow leading to DM dispatch.
*   **Edge Cases & Error Handling:** Test with invalid inputs, empty option sets, etc., for all commands and interactions.

## Known Issues & Considerations

*   **`RankedVoteView` Implementation:** Needs completion or thorough verification for Borda and Runoff.
*   **D'Hondt Method Interpretation for Single Winner:** The `count_votes` logic might need review to ensure it's clear how a single "winner" is determined if the mechanism is used outside typical multi-seat allocation. Current implementation defaults to Plurality-like winner for this.
*   **Timestamp Format for Existing Data:** Still a potential issue for very old data.
*   **Modal Component Limits:** Remains a constraint.
*   **`original_interaction` Handling in Views:** Unchanged.

## Evolution of Project Decisions

*   (No major new evolutions since last update, primarily bug fixing and incremental feature completion related to the DM voting loop.)