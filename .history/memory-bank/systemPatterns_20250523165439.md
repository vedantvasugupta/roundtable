# System Patterns: Governance Bot Architecture

## High-Level Architecture

The system is a Python-based Discord bot designed for asynchronous operation using the `discord.py` library. It interacts with an SQLite database via `aiosqlite` for persistent storage of all governance-related data.

## Core Components and Modules

*   **`main.py`**: Entry point of the bot. Initializes the bot, loads cogs/modules, sets up event listeners (e.g., `on_ready`), and background tasks.
*   **`db.py`**: Handles all database interactions. Includes functions for initializing the database schema, and CRUD (Create, Read, Update, Delete) operations for proposals, votes, settings, users, etc. It uses `aiosqlite` for asynchronous database access.
*   **`proposals.py`**: Manages the proposal lifecycle. This includes:
    *   The new two-step proposal creation UX (Mechanism Selection View with buttons -> Mechanism-specific Modal).
    *   Logic for creating, approving, and rejecting proposals.
    *   Interaction with `db.py` to store and retrieve proposal data.
*   **`voting.py`**: Handles the voting process. This includes:
    *   Generating voting interfaces (e.g., DMs with buttons/dropdowns for different voting mechanisms).
    *   Processing and validating votes.
    *   Storing votes in the database via `db.py`.
*   **`voting_utils.py`**: Contains utility functions related to voting, such as vote counting for different mechanisms, result formatting, deadline checking, and result announcement.
*   **`utils.py`**: A collection of general utility functions used across the bot (e.g., parsing durations, managing Discord channels, formatting text).
*   **`moderation.py`**: Implements moderation commands and logic (warnings, mutes, bans).

## Key Design Patterns

*   **Modular Design:** Functionality is separated into different Python modules/files (as listed above) to improve organization and maintainability.
*   **Asynchronous Programming:** Extensive use of `async` and `await` for non-blocking operations, essential for a responsive Discord bot handling multiple concurrent interactions and background tasks.
*   **View-Modal Interaction for Proposal Creation:**
    1.  A `discord.ui.View` (`ProposalMechanismSelectionView`) presents buttons for choosing a voting mechanism.
    2.  Clicking a button triggers a callback that opens a specific `discord.ui.Modal` (e.g., `PluralityProposalModal`, `BordaProposalModal`) tailored to the selected mechanism. This pattern overcomes Discord's limitation of not having dynamic fields within a single modal.
*   **Database Abstraction:** Database logic is encapsulated within `db.py`, so other modules don't interact directly with SQL queries but call dedicated asynchronous functions.
*   **Configuration via Database:** Server-specific settings and constitutional variables are stored in and read from the database, allowing for per-server customization.
*   **Background Tasks:** `discord.py`'s `tasks` extension is used for periodic checks like proposal deadlines, pending result announcements, and expired moderations.

## Data Storage

*   **SQLite Database (`bot_database.db`):**
    *   `proposals` table: Stores proposal details, including title, description, proposer, voting mechanism, deadline, status, and a JSON field for `hyperparameters`.
    *   `proposal_options` table: Stores the specific options for each proposal.
    *   `votes` table: Records individual votes.
    *   `settings` table: Stores server-specific settings.
    *   `constitutional_variables` table: Stores server-specific governance rules.
    *   Other tables for users, warnings, moderation actions, etc.
*   **JSON for Hyperparameters:** Voting mechanism-specific hyperparameters are stored as a JSON string in the `proposals` table, allowing for flexibility as different mechanisms have different configuration needs.